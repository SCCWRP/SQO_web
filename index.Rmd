---
title: "Sediment Quality Objectives: Web tool"
author: ""
output: 
  html_document
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, echo = F}
library(knitr)
library(tidyverse)
library(shiny)
opts_chunk$set(warning = FALSE, message = FALSE, eval = T, echo = F)

source('R/funcs.R')

# data inputs
data("indic_lookup")
biota <- read.csv('data/biota.csv', stringsAsFactors = FALSE)
constants <- read.csv('data/constantsSF.csv', stringsAsFactors = FALSE)
contam <- read.csv('data/contamSF.csv', stringsAsFactors = FALSE)
biota_preyprop <- read.csv('data/preyprop.csv', stringsAsFactors = FALSE, row.names = 1)

# indicator species lookup format for inputs
indic_lookup <- indic_lookup %>% 
  group_by(Indicator.number) %>% 
  nest %>% 
  deframe %>% 
  map(function(x) pull(x, Guild.species))
```

# {.tabset}

## Model inputs

```{r}
column(12, 
  h3('Indicator guild species'),
  wellPanel(id = "indicspec", style = "overflow-y:scroll; max-height: 500px; background-color:#daf1da",
    
    # indic 1        
    fluidRow(
      column(4, h6('1 Piscivore')),
      column(3, selectInput('indic1', NULL, choices = indic_lookup[['Indicator species 1']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic1lip', NULL, value = 0.0036, min = 0, max = 1, width = '40%'))
    ),
    
    # indic 2        
    fluidRow(
      column(4, h6('2 Benthic diet with piscivory')),
      column(3, selectInput('indic2', NULL, choices = indic_lookup[['Indicator species 2']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic2lip', NULL, value = 0.0044, min = 0, max = 1, width = '40%'))
    ),
    
    # indic 3        
    fluidRow(
      column(4, h6('3 Benthic and pelagic with piscivory')),
      column(3, selectInput('indic3', NULL, choices = indic_lookup[['Indicator species 3']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic3lip', NULL, value = 0.0158, min = 0, max = 1, width = '40%'))
    ),

    # indic 4        
    fluidRow(
      column(4, h6('4 Benthic without piscivory')),
      column(3, selectInput('indic4', NULL, choices = indic_lookup[['Indicator species 4']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic4lip', NULL, value = 0.0329, min = 0, max = 1, width = '40%'))
    ),

    # indic 5
    fluidRow(
      column(4, h6('5 Benthic and pelagic without piscivory')),
      column(3, selectInput('indic5', NULL, choices = indic_lookup[['Indicator species 5']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic5lip', NULL, value = 0.0125, min = 0, max = 1, width = '40%'))
    ),

    # indic 6        
    fluidRow(
      column(4, h6('6 Benthic with herbivory')),
      column(3, selectInput('indic6', NULL, choices = indic_lookup[['Indicator species 6']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic6lip', NULL, value = 0.0356, min = 0, max = 1, width = '40%'))
    ),

    # indic 7        
    fluidRow(
      column(4, h6('7 Benthic and pelagic with herbivory')),
      column(3, selectInput('indic7', NULL, choices = indic_lookup[['Indicator species 7']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic7lip', NULL, value = 0.0117, min = 0, max = 1, width = '40%'))
    ),

    # indic 8        
    fluidRow(
      column(4, h6('8 Pelagic with benthic herbivory')),
      column(3, selectInput('indic8', NULL, choices = indic_lookup[['Indicator species 8']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic8lip', NULL, value = 0.0444, min = 0, max = 1, width = '40%'))
    ),

    # indic 9        
    fluidRow(
      column(4, h6('9 Benthic diet with piscivory (white catfish)')),
      column(3, selectInput('indic9', NULL, choices = indic_lookup[['Indicator species 9']])),
      column(1, h6('Lipid')),
      column(4, numericInput('indic9lip', NULL, value = 0.0036, min = 0, max = 1, width = '40%'))
    )

  )
)
```

## Run bioaccumulation model

```{r}
actionButton("run", "Run!")

bsaf_res <- eventReactive(input$run, {
  
  # format biota from input
  biota <- formsppinp(input, biota)

  res <- bioaccum_batch(biota, contam, biota_preyprop, constants)

  return(res)
  
})

renderUI({
  
  # input
  bsaf_res <- bsaf_res()
  BSAF <- bsaf_res$BSAF
  
  selectInput('cntbsaf', 'Select contaminant:', choices = colnames(BSAF))
  
})

renderPlot({
  
  bsaf_res <- bsaf_res()
  BSAF <- bsaf_res$BSAF
  CBIOTA <- bsaf_res$CBIOTA
  contam <- bsaf_res$contam
  cntbsaf <- input$cntbsaf
  
  req(cntbsaf)
  
  toplo <- BSAF %>% 
    data.frame %>% 
    rownames_to_column('species') %>% 
    select(species, !!cntbsaf)
  
  p <- ggplot(toplo, aes_string(x = 'species', y = cntbsaf)) + 
    geom_bar(stat = 'identity') + 
    ylab('BSAF') + 
    theme_bw(base_size= 16, base_family = 'serif')+ 
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.title.x = element_blank()
      )
  
  return(p)
  
})


renderUI({
  
  # input
  bsaf_res <- bsaf_res()
  BSAF <- bsaf_res$BSAF
  
  selectInput('sppbsaf', 'Select species:', choices = rownames(BSAF))
  
})

renderPlot({
  
  bsaf_res <- bsaf_res()
  BSAF <- bsaf_res$BSAF
  CBIOTA <- bsaf_res$CBIOTA
  contam <- bsaf_res$contam
  sppbsaf <- input$sppbsaf
  
  req(sppbsaf)
  
  toplo <- BSAF %>% 
    data.frame %>% 
    rownames_to_column('species') %>% 
    filter(species %in% sppbsaf) %>% 
    gather('contam', 'val', -species)
  
  p <- ggplot(toplo, aes_string(x = 'contam', y = 'val')) + 
    geom_bar(stat = 'identity') + 
    ylab('BSAF') + 
    theme_bw(base_size= 16, base_family = 'serif')+ 
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.title.x = element_blank()
      )
  
  return(p)
  
})

renderPlot({
 
  bsaf_res <- bsaf_res()
  BSAF <- bsaf_res$BSAF
  CBIOTA <- bsaf_res$CBIOTA
  contam <- bsaf_res$contam
  sppbsaf <- input$sppbsaf

  toplo <- BSAF %>% 
    data.frame %>% 
    rownames_to_column('species') %>% 
    filter(species %in% sppbsaf) %>% 
    gather('Chem', 'val', -species) %>%
    mutate(Chem = factor(Chem)) %>% 
    left_join(contam, by = 'Chem')
  
  p <- ggplot(toplo, aes(x = Kow, y = val)) + 
    geom_point() + 
    scale_x_log10('log10 Octanol-water partitioning coeff') + 
    ylab('BSAF') + 
    theme_bw(base_size= 16, base_family = 'serif')
  
  return(p)
  
})
```
